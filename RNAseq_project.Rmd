---
title: "RNAseq_project"
output: html_notebook
---

#Búsqueda de proyecto

En la página de rcount3 R buscámos un proyecto de nuestro agrado. Este proyecto estará orientado a la enfermedad de Alzheimer, entonces buscamos datos disponibles en humanos con Alzheimer.

```{r, echo=TRUE}
## Cambiar el URL de recount3 a Amazon (AWS)

## Load recount3 R package
library("recount3")

getOption(
  "recount3_url",
  "http://duffel.rail.bio/recount3"
)

options(recount3_url = "https://recount-opendata.s3.amazonaws.com/recount3/release")

## Confirmando que se cambió el URL
getOption(
  "recount3_url",
  "http://duffel.rail.bio/recount3"
)

## Vemos los proyectos disponibles de humano y alzheimer
human_projects <- available_projects(organism = "human")


## Encontramos proyecto SRP060205
project_info <- subset(
  human_projects,
  project == "SRP107565"
)

## Cremos un objeto de tipo RangedSummarizedExperiment (RSE)
## con la información a nivel de genes

rse_gene_SRP107565 <- create_rse(project_info)

## Visualizamos el objeto
rse_gene_SRP107565
## vemos dimensiones de 63856 (genes)  x 216 (muestras)

```

# Formateando y visualizando los datos del experimento SRP060205
```{r}
## Convirtamos las cuentas por nucleotido a cuentas por lectura
## usando compute_read_counts().
assay(rse_gene_SRP107565, "counts") <- compute_read_counts(rse_gene_SRP107565)

## Haciendo el experimento más fácil de usar
rse_gene_SRP107565 <- expand_sra_attributes(rse_gene_SRP107565)
colData(rse_gene_SRP107565)[
    ,
    grepl("^sra_attribute", colnames(colData(rse_gene_SRP107565)))
]

## Pasamos los atributos de caracter a factor
rse_gene_SRP107565$sra_attribute.agent <- factor(tolower(rse_gene_SRP107565$sra_attribute.agent))

rse_gene_SRP107565$sra_attribute.cell_line <- factor(toupper(rse_gene_SRP107565$sra_attribute.cell_line))

## Seleccionamos solo los valores numéricos para el atributo dose
match <- gregexpr("([0-9]*[.])?[0-9]+", rse_gene_SRP107565$sra_attribute.dose)
x <- regmatches(rse_gene_SRP107565$sra_attribute.dose, match)

rse_gene_SRP107565$sra_attribute.dose <- as.numeric(x)

## Seleccionamos todos los caracteres hasta el primer espacio en source.name
library(stringr)
x <- word(rse_gene_SRP107565$sra_attribute.source_name, 1)
rse_gene_SRP107565$sra_attribute.source_name <- factor(x)

## Seleccionamos solo los número de las horar en time
x <- str_extract(rse_gene_SRP107565$sra_attribute.time, "(\\d+)(?=\\s+hr)")
rse_gene_SRP107565$sra_attribute.time <- as.numeric(x)

## Vemos el resumen de las variables de interés
summary(as.data.frame(colData(rse_gene_SRP107565)[
    ,
    grepl("^sra_attribute.[agent|cell_line|dose|source_name|time]", colnames(colData(rse_gene_SRP107565)))
]))

## Vemos que hay dos columnas que se repiten, entonces podemos usar cualquiera de las dos.
## Ya sea cell_line o source_name.
```
## Exploramos variables de interés para ver calidad.
 
```{r}
## Vemos la proporción de lecturas asignadas a genes.
rse_gene_SRP107565$assigned_gene_prob <- rse_gene_SRP107565$recount_qc.gene_fc_count_all.assigned/rse_gene_SRP107565$recount_qc.gene_fc_count_all.total
summary(rse_gene_SRP107565$assigned_gene_prob)

library(ggplot2)
## Hacer un data.frame para graficar más fácil.
plot_df <- as.data.frame(colData(rse_gene_SRP107565)[
    ,
    grepl("^sra_attribute", colnames(colData(rse_gene_SRP107565)))
])

colnames(plot_df)<- c("agent", "cell_line", "dose", "source_name", "time")
plot_df$assigned_gene_prob <- rse_gene_SRP107565$assigned_gene_prob

## Vemos las diferencias entre los grupos de tratamiento con un scatter plot.
## Visualizamos
ggplot(data=plot_df, aes(x=assigned_gene_prob, y=agent, color=agent)) + 
  geom_point() +
  theme(legend.position = "none")
```
Vemos que son bastantes similares los grupos a estudiar, las líneas celulares tratadas con ribociclib y palbociclib son tienen una proporción más alta de genes asignados que abemaciclib.
```{r}
## Vemos la variación entre los grupos

with(colData(rse_gene_SRP107565), tapply(assigned_gene_prob, sra_attribute.agent, summary))
```
Con la función summary vemos que en el grupo los tres grupos tienen la probabilidad de asociarse con genes muy similar, si bien el que tiene un promedio más bajo es ribociclib pero no por mucho (omitiendo el grupo control). Casi todos tienen una mediana muy similar, pero donde vemos las mejores proporciones es con las muestras con palbocilcib. En el grupo de palbociclib vemos que tienen un mínimo de 0.5839, el más alto de los otros dos grupos, así como el primer cuartil y también la media más alta.

## Limpieza de datos
```{r}
## Guardamos los datos crudos
rse_gene_SRP107565_unfiltered <- rse_gene_SRP107565

## Visualizamos la calidad de las muestras
hist(rse_gene_SRP060205_unfiltered$assigned_gene_prob)

## Quitamos las muestras 
table(rse_gene_SRP060205$assigned_gene_prob < 0.35)
rse_gene_SRP060205 <- rse_gene_SRP060205[, rse_gene_SRP060205$assigned_gene_prop > 0.35]

## Para quitar las muestras que no tienen niveles de expresión significativos calculamos los niveles medios de expresión.
genes_prom <- rowMeans(assay(rse_gene_SRP060205, "counts"))


```

